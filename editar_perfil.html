<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Editar Perfil</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #000; color: #fff; font-family: Arial, sans-serif; }
    header {
      background: #111;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      border-bottom: 1px solid #222;
    }
    header h1 { font-size: 18px; }
    .material-icons { cursor: pointer; }
    .container {
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .profile-pic {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .profile-pic img {
      width: 110px;
      height: 110px;
      border-radius: 50%;
      border: 3px solid #1e90ff;
      margin-bottom: 10px;
    }
    .profile-pic input[type="file"] { display: none; }
    .btn-trocar {
      background: #1e90ff;
      color: #fff;
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
    }
    input, textarea {
      background: #111;
      border: 1px solid #333;
      padding: 12px;
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
      width: 100%;
    }
    textarea { resize: none; min-height: 80px; }
    .btn-salvar {
      margin-top: 10px;
      background: #1e90ff;
      color: white;
      border: none;
      padding: 14px;
      border-radius: 8px;
      font-size: 15px;
      cursor: pointer;
    }
    .btn-salvar:hover { background: #187bcd; }
  </style>
</head>
<body>

<header>
  <div onclick="window.location.href='definicao.html'"><i class="material-icons">arrow_back</i></div>
  <h1>Editar Perfil</h1>
  <div></div>
</header>

<div class="container">
  <div class="profile-pic">
    <img id="previewFoto" src="perfil1.jpg" alt="Foto de perfil">
    <label class="btn-trocar">
      Trocar Foto
      <input type="file" accept="image/*" onchange="previewImagem(event)">
    </label>
  </div>

  <input type="text" id="nome" placeholder="Seu nome completo">
  <input type="tel" id="telefone" placeholder="Número de telefone" readonly>
  <textarea id="bio" placeholder="Escreva sua bio..."></textarea>
  <input type="password" id="senha" placeholder="Nova senha (opcional)">
  <button class="btn-salvar" onclick="salvarPerfil()">Salvar Alterações</button>
</div>

<script>
  const firebaseConfig = {
    databaseURL: "https://lifeline-78bce-default-rtdb.firebaseio.com/"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const telefone = localStorage.getItem("usuarioLogado");

  window.onload = () => {
    if (!telefone) {
      alert("Usuário não logado.");
      window.location.href = "teste.html"; // Página de login
      return;
    }

    firebase.database().ref("usuarios/" + telefone).once("value").then(snapshot => {
      const user = snapshot.val();
      if (user) {
        document.getElementById("nome").value = user.nome || "";
        document.getElementById("telefone").value = user.telefone || "";
        document.getElementById("bio").value = user.bio || "";
        document.getElementById("previewFoto").src = user.foto || "perfil1.jpg";
        localStorage.setItem("perfil_usuario", JSON.stringify(user)); // backup local
      }
    });
  };

  function previewImagem(event) {
    const reader = new FileReader();
    reader.onload = () => {
      document.getElementById("previewFoto").src = reader.result;
    };
    reader.readAsDataURL(event.target.files[0]);
  }

  function salvarPerfil() {
    const nome = document.getElementById("nome").value.trim();
    const bio = document.getElementById("bio").value.trim();
    const senha = document.getElementById("senha").value.trim();
    const foto = document.getElementById("previewFoto").src;

    if (!nome) {
      alert("Digite seu nome.");
      return;
    }

    const novosDados = { nome, bio, foto };
    if (senha) novosDados.senha = senha;

    firebase.database().ref("usuarios/" + telefone).update(novosDados)
      .then(() => {
        alert("Perfil atualizado com sucesso!");
        firebase.database().ref("usuarios/" + telefone).once("value").then(snapshot => {
          localStorage.setItem("perfil_usuario", JSON.stringify(snapshot.val()));
          window.location.href = "definicao.html"; // Redireciona para tela de configurações
        });
      })
      .catch(error => {
        console.error("Erro ao salvar:", error);
        alert("Erro ao atualizar perfil.");
      });
  }
</script>

</body>
</html>